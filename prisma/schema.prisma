generator client {
  provider      = "prisma-client-js"
  // Output to default location (node_modules/@prisma/client)
  // output        = "../src/generated/prisma_v2"
  
  // Only include necessary binary targets for deployment
  // "native" = local development, "rhel-openssl-3.0.x" = Vercel serverless
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CustomerTier {
  VENDOR // Wholesale buyers, highest discount
  RETAILER // Shop owners, medium discount
  CUSTOMER // End consumers, MRP or minimal discount
}

// Sales Pipeline Status for Customer Kanban
enum CustomerStatus {
  LEAD // New potential customer
  PROSPECT // Qualified and engaged
  NEGOTIATING // In active discussions
  WON // Converted to paying customer
  LOST // Did not convert
}

// Core user and org models
model User {
  id                      String                   @id @default(auto()) @map("_id") @db.ObjectId
  email                   String                   @unique
  password                String
  isActive                Boolean                  @default(true)
  emailVerified           Boolean                  @default(false)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  lastLoginAt             DateTime?
  defaultOrganizationId   String?                  @db.ObjectId
  defaultOrganization     Organization?            @relation("UserDefaultOrganization", fields: [defaultOrganizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ownedOrganizations      Organization[]           @relation("OrganizationOwner")
  memberships             OrganizationMembership[]
  profile                 UserProfile?
  roles                   UserRole[]
  departmentId            String?                  @db.ObjectId
  department              Department?              @relation(fields: [departmentId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  managerId               String?                  @db.ObjectId
  manager                 User?                    @relation("UserManager", fields: [managerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reports                 User[]                   @relation("UserManager")
  activities              Activity[]
  notifications           Notification[]
  auditLogs               AuditLog[]
  qualityTests            QualityTest[]
  ticketComments          TicketComment[]
  documentsUploaded       Document[]
  salesTargets            SalesTarget[]
  commissions             Commission[]
  verificationTokens      VerificationToken[]
  magicLinkTokens         MagicLinkToken[]         @relation("MagicLinkTokens")
  passwordResetTokens     PasswordResetToken[]     @relation("PasswordResetTokens")
  emailVerificationTokens EmailVerificationToken[] @relation("EmailVerificationTokens")
  invitationsSent         OrganizationInvite[]     @relation("InvitedBy")
  materialRequests        MaterialRequest[]
  tasksAssigned           Task[]                   @relation("TaskAssignedTo")
  tasksCreated            Task[]                   @relation("TaskAssignedBy")
  taskAssignments         TaskAssignee[]
  taskComments            TaskComment[]
  taskCommentReads        TaskCommentRead[]
  taskAttachments         TaskAttachment[]
  taskFollows             TaskFollower[]
  attendance              Attendance[]
  leaveRequests           LeaveRequest[]
  approvedLeaves          LeaveRequest[]           @relation("LeaveApprover")
  shiftId                 String?                  @db.ObjectId
  shift                   Shift?                   @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  pushSubscriptions       PushSubscription[]
  createdConnections      Connection[]             @relation("CreatedConnections")
  connectionId            String?                  @db.ObjectId
  connection              Connection?              @relation("UserConnection", fields: [connectionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  productionPlansCreated  ProductionPlan[]         @relation("ProductionPlanCreator")
  productionPlansApproved ProductionPlan[]         @relation("ProductionPlanApprover")
  stockAlertsAcknowledged StockAlert[]             @relation("AlertAcknowledger")

  // POS Relations
  ownedPOSLocations      POSLocation[]    @relation("POSOwner")
  posAlertsAcknowledged  POSStockAlert[]  @relation("POSAlertAcknowledger")
  posOrdersCreated       POSOrder[]       @relation("POSOrderCreator")
  posTransactionsCashier POSTransaction[] @relation("POSTransactionCashier")
  posSessions            POSSession[]     @relation("POSSessionCashier")

  // Import Relations
  importBatches ImportBatch[] @relation("ImportBatchUser")
  recordedDailyStocks    DailyStockRecord[] @relation("RecordedDailyStocks")
  verifiedDailyStocks    DailyStockRecord[] @relation("VerifiedDailyStocks")

  // Membership approvals
  approvedMemberships    OrganizationMembership[] @relation("MembershipApprover")

  // HR & Payroll Relations
  employeeSalaries       EmployeeSalary[]
  payrollItems           PayrollItem[]
  leaveBalances          LeaveBalance[]
  overtimeRecords        OvertimeRecord[]
  overtimeApprovals      OvertimeRecord[]         @relation("OvertimeApprover")
  payrollsProcessed      Payroll[]                @relation("PayrollProcessor")
  
  // Employee Purchases & Bonus Relations
  employeePurchases         EmployeePurchase[]
  employeePurchasesCreated  EmployeePurchase[]    @relation("EmployeePurchaseCreator")
  employeeBonuses           EmployeeBonus[]
  employeeBonusesCreated    EmployeeBonus[]       @relation("BonusCreator")
  employeeBonusesApproved   EmployeeBonus[]       @relation("BonusApprover")

  // Expense Relations
  expensesCreated          Expense[]              @relation("ExpenseCreator")
  recurringExpensesCreated RecurringExpense[]      @relation("RecurringExpenseCreator")
}

model Organization {
  id                      String  @id @default(auto()) @map("_id") @db.ObjectId
  name                    String
  slug                    String  @unique
  code                    String  @unique // 6-8 character alphanumeric code for joining
  ownerId                 String  @db.ObjectId
  procurementWorkflowMode String? @default("FULL") // "FULL" or "DIRECT"
  challanInventoryAutoUpdate Boolean? @default(true) // Toggle inventory deduction on challan dispatch
  globalTaxPercent        Float   @default(0) // Global tax percentage
  // Catalog settings
  catalogPricingMode      String? @default("SHOW_MARKED") // SHOW_MARKED, SHOW_SELLING, HIDE_PRICING, CONTACT_FOR_PRICE
  catalogEnabled          Boolean @default(true) // Enable public catalog for this org
  catalogDescription      String? // Public catalog description
  catalogLogoUrl          String? // Logo for public catalog

  // Business Address Details (for GST calculation and invoicing)
  businessAddress String? // Full business address
  city            String? // City
  state           String? // State (for GST calculation - CGST/SGST vs IGST)
  stateCode       String? // State code (e.g., "27" for Maharashtra)
  pincode         String? // PIN code
  gstNumber       String? // Organization's GST number
  panNumber       String? // PAN number
  cinNumber       String? // CIN for companies

  // Contact Details
  contactPhone String? // Primary contact number
  contactEmail String? // Primary contact email
  website      String? // Company website
  
  // Banking Details (for Tally and invoice footer)
  bankName          String? // Bank name
  bankAccountNumber String? // Account number
  bankIfscCode      String? // IFSC code
  bankBranchName    String? // Branch name
  bankBranchAddress String? // Branch address
  bankAccountType   String? // CURRENT, SAVINGS
  
  // Validation tracking
  companyDetailsComplete Boolean @default(false) // Track if all required details are filled

  // Invoice Settings
  invoicePrefix       String? @default("INV") // Invoice number prefix
  invoiceTerms        String? // Default terms and conditions
  invoiceDeclaration  String? // Declaration text for invoice footer
  authorizedSignatory String? // Name of authorized signatory
  signatureImageUrl   String? // Digital signature image URL
  companyStampUrl     String? // Company stamp/seal image URL

  // Additional Tax Identifiers
  fssaiLicenseNumber String? // FSSAI license for food businesses
  udyamNumber        String? // Udyam registration number (MSME)
  tanNumber          String? // TAN for TDS

  // Super Admin Control
  isPaused           Boolean  @default(false) // If true, organization is paused (e.g., for payment issues)

  // Onboarding tracking
  onboardingCompleted   Boolean   @default(false)
  onboardingCompletedAt DateTime?
  onboardingSteps       Json?     @default("{}") // { rawMaterials: bool, supplier: bool, customer: bool, product: bool, margins: bool, quickBill: bool, inviteB2B: bool, invitePOS: bool }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner        User                     @relation("OrganizationOwner", fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  memberships  OrganizationMembership[]
  defaultUsers User[]                   @relation("UserDefaultOrganization")

  connections             Connection[]
  products                Product[]
  milkCollectionCenters   MilkCollectionCenter[]
  milkProcurements        MilkProcurementEntry[]
  milkRateCharts          MilkRateChart[]
  customerMilkCollections CustomerMilkCollection[]
  mandaliSessionSummaries MandaliSessionSummary[]
  bmcMilkCollections      BMCMilkCollection[]
  bmcStorage              BMCStorage[]
  bmcDailySummaries       BMCDailySummary[]
  tankers                 Tanker[]
  tankerLoads             TankerLoad[]
  dairyMilkReceipts       DairyMilkReceipt[]
  directDairyReceipts     DirectDairyReceipt[]
  paymentLedgers          PaymentLedger[]
  customerPayments        CustomerPayment[]
  mandaliPayments         MandaliPayment[]
  bmcPayments             BMCPayment[]
  productionBatches       ProductionBatch[]
  qualityTests            QualityTest[]
  salesInquiries          SalesInquiry[]
  quotations              Quotation[]
  salesOrders             SalesOrder[]
  orderItems              OrderItem[]
  invoices                Invoice[]
  payments                Payment[]
  deliveryChallans        DeliveryChallan[]
  storageLocations        StorageLocation[]
  inventoryStocks         InventoryStock[]
  inventoryTransactions   InventoryTransaction[]
  materialRequests        MaterialRequest[]
  purchaseOrders          PurchaseOrder[]
  bills                   Bill[]
  supportTickets          SupportTicket[]
  supplierFeedbacks       SupplierFeedback[]
  activities              Activity[]
  documents               Document[]
  notifications           Notification[]
  salesTargets            SalesTarget[]
  commissions             Commission[]
  commissionRules         CommissionRule[]
  auditLogs               AuditLog[]
  invites                 OrganizationInvite[]
  gateEntries             GateEntry[]
  massComplaints          MassComplaint[]
  festivalData            FestivalData[]
  workflowStatuses        WorkflowStatus[]
  tasks                   Task[]
  machines                Machine[]
  attendance              Attendance[]
  leaveRequests           LeaveRequest[]
  pushSubscriptions       PushSubscription[]
  shifts                  Shift[]
  recipes                 Recipe[]
  whatsappContacts        WhatsAppContact[]
  customerMargins         CustomerMargin[]
  productMargins          ProductMargin[]
  customerProductMargins  CustomerProductMargin[]
  productionPlans         ProductionPlan[]
  stockAlerts             StockAlert[]
  productImages           ProductImage[]
  productCategories       ProductCategory[]
  publicInquiries         PublicInquiry[]
  storage                 OrganizationStorage?
  dailyStockRecords       DailyStockRecord[]

  // POS Relations
  posLocations    POSLocation[]
  posStockAlerts  POSStockAlert[]
  posOrders       POSOrder[]
  posInvoices     POSInvoice[]
  posTransactions POSTransaction[]
  posCustomers    POSCustomer[]
  posSessions     POSSession[]

  // Import Relations
  importBatches ImportBatch[]

  complaintIssueTypes ComplaintIssueType[]

  // HR & Payroll Relations
  holidays            Holiday[]
  weeklyOffs          WeeklyOff[]
  salaryComponents    SalaryComponent[]
  employeeSalaries    EmployeeSalary[]
  payrolls            Payroll[]
  leaveTypes          LeaveType[]
  leaveBalances       LeaveBalance[]
  overtimeRecords     OvertimeRecord[]
  employeePurchases   EmployeePurchase[]
  employeeBonuses     EmployeeBonus[]

  // Expense Relations
  expenses           Expense[]
  expenseCategories  ExpenseCategory[]
  recurringExpenses  RecurringExpense[]
}

model OrganizationMembership {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  userId          String    @db.ObjectId
  organizationId  String    @db.ObjectId
  role            String    // ADMIN, MEMBER, OWNER
  status          String    @default("ACTIVE") // PENDING, ACTIVE, REJECTED
  requestedRole   String?   // The functional role code they requested (e.g., "8" for SALES)
  approvedById    String?   @db.ObjectId
  approvedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime  @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  approvedBy   User?         @relation("MembershipApprover", fields: [approvedById], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([userId, organizationId])
}

model Task {
  id                    String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId        String       @db.ObjectId
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  title                 String
  description           String?
  assignedById          String       @db.ObjectId
  assignedBy            User         @relation("TaskAssignedBy", fields: [assignedById], references: [id], onDelete: NoAction)
  assignedToId          String?      @db.ObjectId
  assignedTo            User?        @relation("TaskAssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)
  assigneeName          String?
  roleOfAssignee        String // lowercase role key: admin, supervisor, operator, etc.
  priority              TaskPriority @default(MEDIUM)
  status                TaskStatus   @default(PENDING)
  dueDate               DateTime?
  tags                  String[]     @default([])
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  assignmentEmailSent   Boolean      @default(false)
  assignmentEmailSentAt DateTime?
  assignmentEmailError  String?

  // Multiple assignees support (new)
  assignees     TaskAssignee[]
  // Legacy single assignee (kept for backward compatibility)
  comments      TaskComment[]
  attachments   TaskAttachment[]
  followers     TaskFollower[]
  notifications Notification[]   @relation("TaskNotifications")

  @@index([organizationId, assignedToId])
  @@index([organizationId, status])
}

model TaskComment {
  id        String            @id @default(auto()) @map("_id") @db.ObjectId
  taskId    String            @db.ObjectId
  task      Task              @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId  String            @db.ObjectId
  author    User              @relation(fields: [authorId], references: [id], onDelete: NoAction)
  content   String
  createdAt DateTime          @default(now())
  readBy    TaskCommentRead[]
}

model TaskAttachment {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  taskId         String    @db.ObjectId
  task           Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedById   String    @db.ObjectId
  uploadedBy     User      @relation(fields: [uploadedById], references: [id], onDelete: NoAction)
  fileName       String
  fileUrl        String
  fileType       String?
  fileSize       Int?
  blobName       String? // Azure blob name for direct reference
  lastAccessedAt DateTime? // Track when file was last accessed
  videoUrl       String? // YouTube or external video URL reference
  createdAt      DateTime  @default(now())

  @@index([taskId])
  @@index([uploadedById])
}

// Track organization storage usage for 20GB limit
model OrganizationStorage {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @unique @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  usedBytes      Float        @default(0) // Total bytes used
  fileCount      Int          @default(0) // Total file count
  updatedAt      DateTime     @updatedAt
}

// TaskAssignee: Many-to-many relationship for multiple assignees per task
// Supports both single assignee (via assignedToId) and multiple assignees (via this model)
model TaskAssignee {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId     String   @db.ObjectId
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedAt DateTime @default(now())

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

// TaskCommentRead: Tracks which comments have been read by which users
model TaskCommentRead {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  commentId String      @db.ObjectId
  comment   TaskComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId    String      @db.ObjectId
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  readAt    DateTime    @default(now())

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

// TaskFollower: Users following a task for notifications
model TaskFollower {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  taskId     String   @db.ObjectId
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  followedAt DateTime @default(now())

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

model UserProfile {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @unique @db.ObjectId
  user              User    @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  fullName          String
  phone             String?
  address           String?
  city              String?
  state             String?
  postalCode        String?
  country           String?
  roleTitle         String?
  profilePictureUrl String?
  bio               String?
}

model Role {
  id    String     @id @default(auto()) @map("_id") @db.ObjectId
  name  String     @unique
  desc  String?
  users UserRole[]
}

model UserRole {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  userId String @db.ObjectId
  role   Role   @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  roleId String @db.ObjectId

  @@unique([userId, roleId])
}

model Department {
  id    String  @id @default(auto()) @map("_id") @db.ObjectId
  name  String  @unique
  desc  String?
  users User[]
}

// Connections and contacts
model Connection {
  id                  String          @id @default(auto()) @map("_id") @db.ObjectId
  organizationId      String          @db.ObjectId
  organization        Organization    @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  name                String
  type                String // e.g., "SUPPLIER", "CUSTOMER", "BOTH"
  businessCategory    String // e.g., "DAIRY_FARM", "DISTRIBUTOR"
  primaryContactId    String?
  createdById         String?         @db.ObjectId // Track who created this connection
  createdBy           User?           @relation("CreatedConnections", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  contacts            ContactPerson[]
  fssaiLicenses       FSSAILicense[]
  gstNumber           String?
  panNumber           String? // PAN number (for TDS)
  creditLimit         Float?          @default(0)
  paymentTermsDays    Int?            @default(0)
  hasColdStorage      Boolean?        @default(false)
  deliveryPreferences String?
  discountPercent     Float?          @default(0) // Discount/margin percentage for this connection
  discountCategories  String[]        @default([]) // Categories where discount applies (empty = all)

  // Billing Address
  billingAddressLine1 String? // Address line 1
  billingAddressLine2 String? // Address line 2
  village             String? // Customer village/location (legacy - use billingAddressLine1)
  city                String? // City
  state               String? // State name
  stateCode           String? // State code (e.g., "27" for Maharashtra)
  pincode             String? // PIN code
  country             String? @default("India") // Country

  // Shipping Address (if different from billing)
  shippingAddressLine1       String?
  shippingAddressLine2       String?
  shippingCity               String?
  shippingState              String?
  shippingStateCode          String?
  shippingPincode            String?
  shippingCountry            String? @default("India")
  useSeperateShippingAddress Boolean @default(false)

  // Multi-Tier Pricing (Phase 2)
  customerTier     CustomerTier @default(CUSTOMER) // VENDOR, RETAILER, CUSTOMER
  tierAssignedAt   DateTime?
  tierAssignedById String?      @db.ObjectId

  // Sales Pipeline Status for Customer Kanban
  customerStatus          CustomerStatus @default(LEAD)
  customerStatusChangedAt DateTime?

  defaultCollectionCenterId String?                  @db.ObjectId
  defaultCollectionCenter   MilkCollectionCenter?    @relation("DefaultCollectionCenter", fields: [defaultCollectionCenterId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  procurements              MilkProcurementEntry[]
  customerMilkCollections   CustomerMilkCollection[]
  directDairyReceipts       DirectDairyReceipt[]
  customerPayments          CustomerPayment[]
  salesInquiries            SalesInquiry[]
  quotations                Quotation[]
  salesOrders               SalesOrder[]
  purchaseOrders            PurchaseOrder[]
  bills                     Bill[]
  supportTickets            SupportTicket[]
  supplierFeedbacks         SupplierFeedback[]
  gateEntries               GateEntry[]
  massComplaints            MassComplaint[]
  whatsappContacts          WhatsAppContact[]
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime                 @updatedAt

  users                  User[]                          @relation("UserConnection")
  invites                OrganizationInvite[]            @relation("ConnectionInvite")
  customerMargin         CustomerMargin?
  customerProductMargins CustomerProductMargin[]
  materialRequirements   ProductionMaterialRequirement[] @relation("MaterialSupplier")
  stockAlerts            StockAlert[]                    @relation("AlertSupplier")
  suppliedMaterials      ConnectionMaterial[]            // Materials this supplier provides
  expenses               Expense[]                       @relation("ExpenseSupplier")

  @@index([createdById])
}

model ContactPerson {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  connection   Connection @relation(fields: [connectionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  connectionId String     @db.ObjectId
  fullName     String
  email        String?
  phone        String?
  isPrimary    Boolean    @default(false)
}

model FSSAILicense {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  connection    Connection @relation(fields: [connectionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  connectionId  String     @db.ObjectId
  licenseNumber String
  issueDate     DateTime?
  expiryDate    DateTime?
}

// Supplier-Material relationship (which suppliers provide which materials)
model ConnectionMaterial {
  id                String     @id @default(auto()) @map("_id") @db.ObjectId
  connectionId      String     @db.ObjectId
  connection        Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  materialId        String     @db.ObjectId
  material          Product    @relation("SuppliedMaterials", fields: [materialId], references: [id], onDelete: Cascade)
  unitPrice         Float?     // Supplier's price for this material
  leadTimeDays      Int?       // Delivery lead time in days
  minimumOrderQty   Float?     // Minimum order quantity
  preferredSupplier Boolean    @default(false) // Is this the preferred supplier?
  notes             String?    // Additional notes
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@unique([connectionId, materialId])
  @@index([materialId])
}

// Products & catalog
model Product {
  id                String           @id @default(auto()) @map("_id") @db.ObjectId
  organizationId    String           @db.ObjectId
  organization      Organization     @relation(fields: [organizationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sku               String?          @unique
  name              String
  alias             String? // Short name/code for quick search (Tally: alias field)
  category          String // e.g., "MILK", "CURD", "BUTTER"
  subCategory       String?
  description       String?
  unit              String // e.g., "LITRE", "KG", "PIECE"
  packSize          String? // human readable: "200 ml", "1 L"
  minFatPercent     Float?
  minSnfPercent     Float?
  shelfLifeDays     Int?
  storageTempMin    Float?
  storageTempMax    Float?
  requiresColdChain Boolean          @default(false)
  unitPrice         Float? // Selling price
  costPrice         Float? // Internal cost (for profit calculation)
  markedPrice       Float? // MRP - Maximum Retail Price (displayed)
  currentStock      Float?           @default(0) // Float for Float
  stockMfgDate      DateTime?        // Manual manufacturing date for initial stock
  // Composition and quality fields
  moisturePercent   Float?
  proteinPercent    Float?
  lactosePercent    Float?
  totalSolidsPercent Float?
  acidityMin        Float?
  acidityMax        Float?
  phMin             Float?
  phMax             Float?
  reorderLevel      Float?           @default(0) // Float for Float
  minOrderQuantity  Float?           @default(0) // Float for Float
  // Catalog fields
  longDescription   String? // Rich description for catalog
  youtubeVideoUrl   String? // Embedded YouTube video URL
  isPublished       Boolean          @default(false) // Show on public catalog?
  catalogOrder      Int? // Display order in catalog
  categoryId        String?          @db.ObjectId // Link to ProductCategory
  productCategory   ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // HSN/SAC and GST Details (for Tally integration)
  hsnCode           String? // HSN/SAC code for GST (e.g., "04039020" for buttermilk)
  hsnDescription    String? // Description for HSN code (as per GST tariff)
  sacCode           String? // SAC code for services (alternative to HSN)
  gstRate           Float?    @default(5) // GST rate percentage (e.g., 5 for 5%)
  cessRate          Float?    @default(0) // Cess rate percentage (if applicable)
  cessAmount        Float?    @default(0) // Fixed cess amount per unit (if applicable)
  taxabilityType    String?   @default("TAXABLE") // TAXABLE, EXEMPT, NIL_RATED, NON_GST
  typeOfSupply      String?   @default("GOODS") // GOODS or SERVICES
  reverseCharge     Boolean   @default(false) // Is reverse charge applicable
  abatementPercent  Float?    @default(0) // Abatement percentage for services
  rateOfDuty        Float?    @default(0) // Customs/Excise duty rate (for imports)
  gstApplicableFrom DateTime? // Date from which GST is applicable

  // Alternate Units (for products sold in multiple units)
  alternateUnit           String? // e.g., "BOX" when primary unit is "KG"
  alternateUnitConversion Float? // e.g., 15 (1 BOX = 15 KG)
  reportingUOM            String? // Unit of Measurement for reporting (e.g., "KG")

  // Additional Product Details
  batchTracking             Boolean @default(false) // Maintain in batches (for Tally)
  manufacturingDateTracking Boolean @default(false) // Track date of manufacturing
  expiryDateTracking        Boolean @default(false) // Track expiry dates

  // Opening Balance (for Tally import)
  openingStockQty   Float?    @default(0) // Opening stock quantity
  openingStockRate  Float?    @default(0) // Opening rate per unit
  openingStockValue Float?    @default(0) // Opening stock value (qty * rate)
  openingStockDate  DateTime? // As of date for opening stock

  priceHistory               ProductPriceHistory[]
  inventoryStocks            InventoryStock[]
  dailyStockRecords          DailyStockRecord[]
  orderItems                 OrderItem[]
  productionBatches          ProductionBatchItem[]
  productionBatchesByProduct ProductionBatch[]
  quoteLineItems             QuoteLineItem[]
  salesInquiries             SalesInquiry[]
  massComplaints             MassComplaint[]
  festivalData               FestivalData[]
  materialRequests           MaterialRequest[]
  productMargin              ProductMargin?
  customerProductMargins     CustomerProductMargin[]
  productionPlanItems        ProductionPlanItem[]            @relation("PlanProducts")
  materialRequirementsFor    ProductionMaterialRequirement[] @relation("MaterialProduct")
  stockAlerts                StockAlert[]                    @relation("ProductAlerts")
  images                     ProductImage[] // Multiple product images
  publicInquiries            PublicInquiry[] // Inquiries about this product
  supplierMaterials          ConnectionMaterial[]            @relation("SuppliedMaterials") // Suppliers for this material

  // POS Relations
  posStock            POSProductStock[]
  posPricing          POSProductPricing[]
  posStockAlerts      POSStockAlert[]      @relation("POSStockAlertProduct")
  posOrderItems       POSOrderItem[]       @relation("POSOrderItemProduct")
  posTransactionItems POSTransactionItem[] @relation("POSTransactionItemProduct")
  
  // Employee Purchase Relations
  employeePurchases   EmployeePurchase[]
  
  // Purchase Order Item Relations
  poItems             POItem[]             @relation("POItemProduct")
}

model ProductPriceHistory {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  product   Product   @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  productId String    @db.ObjectId
  unitPrice Float
  costPrice Float?
  startDate DateTime
  endDate   DateTime?
}

// Milk procurement
model MilkCollectionCenter {
  id                        String                   @id @default(auto()) @map("_id") @db.ObjectId
  organizationId            String                   @db.ObjectId
  organization              Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name                      String
  latitude                  Float?
  longitude                 Float?
  dailyCapacityL            Float?                   @default(0)
  bmrAvailable              Boolean?                 @default(false)
  hasTestingEquip           Boolean?                 @default(false)
  type                      String? // "MANDALI", "BMC", "STANDARD" or null for backward compatibility
  parentMandaliId           String?                  @db.ObjectId // For BMC â†’ Mandali relationship
  parentMandali             MilkCollectionCenter?    @relation("MandaliToBMC", fields: [parentMandaliId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  bmcCenters                MilkCollectionCenter[]   @relation("MandaliToBMC")
  procurements              MilkProcurementEntry[]
  customerCollections       CustomerMilkCollection[]
  mandaliSummaries          MandaliSessionSummary[]
  bmcCollections            BMCMilkCollection[]      @relation("BMCCenter")
  bmcCollectionsFromMandali BMCMilkCollection[]      @relation("BMCMandali")
  bmcStorage                BMCStorage[]
  bmcDailySummaries         BMCDailySummary[]
  tankerLoads               TankerLoad[]
  tankers                   Tanker[]                 @relation("TankerBMC")
  mandaliPayments           MandaliPayment[]
  bmcPayments               BMCPayment[]
  defaultConnections        Connection[]             @relation("DefaultCollectionCenter")
  dailyStockRecords         DailyStockRecord[]
  expenses                  Expense[]                @relation("ExpenseCollectionCenter")

  @@index([type])
  @@index([parentMandaliId])
}

model MilkProcurementEntry {
  id                 String                @id @default(auto()) @map("_id") @db.ObjectId
  organizationId     String                @db.ObjectId
  organization       Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  supplierId         String                @db.ObjectId
  supplier           Connection            @relation(fields: [supplierId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  collectionCenterId String?               @db.ObjectId
  collectionCenter   MilkCollectionCenter? @relation(fields: [collectionCenterId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  datetime           DateTime
  quantityL          Float
  fatPercent         Float?
  snfPercent         Float?
  clrReading         Float?
  temperatureC       Float?
  qualityGrade       String // e.g., "A", "B", "C"
  ratePerLitre       Float
  totalAmount        Float
  paymentStatus      String                @default("PENDING") // e.g., "PENDING", "PAID"
  milkType           String?
  createdAt          DateTime              @default(now())
  dairyReceipts      DairyMilkReceipt[]
  directDairyReceipt DirectDairyReceipt?
}

model MilkRateChart {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fatPercentMin  Float
  fatPercentMax  Float
  snfPercentMin  Float
  snfPercentMax  Float
  milkType       String
  qualityGrade   String
  ratePerLitre   Float
  effectiveFrom  DateTime
  effectiveTo    DateTime?
}

// Dairy Procurement Workflow Models

model CustomerMilkCollection {
  id             String               @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String               @db.ObjectId
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customerId     String               @db.ObjectId
  customer       Connection           @relation(fields: [customerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  mandaliId      String               @db.ObjectId
  mandali        MilkCollectionCenter @relation(fields: [mandaliId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  session        String // "morning" or "evening"
  date           DateTime             @db.Date
  quantity       Float // Liters
  fat            Float
  snf            Float
  clr            Float
  ratePerLiter   Float
  amount         Float
  createdAt      DateTime             @default(now())

  @@unique([customerId, mandaliId, session, date])
  @@index([mandaliId])
  @@index([date])
  @@index([session])
  @@index([organizationId])
}

model MandaliSessionSummary {
  id                 String               @id @default(auto()) @map("_id") @db.ObjectId
  organizationId     String               @db.ObjectId
  organization       Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  mandaliId          String               @db.ObjectId
  mandali            MilkCollectionCenter @relation(fields: [mandaliId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  date               DateTime             @db.Date
  session            String // "morning" or "evening"
  totalMilk          Float // Total liters
  avgFat             Float
  avgSnf             Float
  avgClr             Float
  totalAmountPayable Float
  customerCount      Int
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  @@unique([mandaliId, date, session])
  @@index([mandaliId])
  @@index([date])
  @@index([organizationId])
}

model BMCMilkCollection {
  id             String               @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String               @db.ObjectId
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bmcId          String               @db.ObjectId
  bmc            MilkCollectionCenter @relation("BMCCenter", fields: [bmcId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  mandaliId      String               @db.ObjectId
  mandali        MilkCollectionCenter @relation("BMCMandali", fields: [mandaliId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  date           DateTime             @db.Date
  session        String // "morning" or "evening"
  receivedMilk   Float // Liters received
  fat            Float
  snf            Float
  clr            Float
  acceptedMilk   Float // Liters accepted after testing
  rejectedMilk   Float // Liters rejected
  testedAt       DateTime             @default(now())
  createdAt      DateTime             @default(now())

  storage BMCStorage[]

  @@index([bmcId])
  @@index([mandaliId])
  @@index([date])
  @@index([organizationId])
}

model BMCStorage {
  id             String               @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String               @db.ObjectId
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bmcId          String               @db.ObjectId
  bmc            MilkCollectionCenter @relation(fields: [bmcId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  collectionId   String               @db.ObjectId
  collection     BMCMilkCollection    @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  storedAt       DateTime             @default(now())
  quantity       Float // Liters stored
  session        String // "morning" or "evening"
  status         String               @default("STORED") // "STORED" or "LOADED"
  createdAt      DateTime             @default(now())

  @@index([bmcId])
  @@index([status])
  @@index([organizationId])
}

model BMCDailySummary {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String               @db.ObjectId
  organization    Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bmcId           String               @db.ObjectId
  bmc             MilkCollectionCenter @relation(fields: [bmcId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  date            DateTime             @db.Date
  totalStoredMilk Float // Total liters stored
  morningMilk     Float // Morning session milk
  eveningMilk     Float // Evening session milk
  avgFat          Float
  avgSnf          Float
  avgClr          Float
  readyForTanker  Boolean              @default(false)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@unique([bmcId, date])
  @@index([bmcId])
  @@index([date])
  @@index([readyForTanker])
  @@index([organizationId])
}

model Tanker {
  id             String                @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String                @db.ObjectId
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bmcId          String?               @db.ObjectId
  bmc            MilkCollectionCenter? @relation("TankerBMC", fields: [bmcId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tankerNumber   String
  capacityL      Float // Capacity in liters
  status         String                @default("AVAILABLE") // "AVAILABLE", "IN_TRANSIT", "LOADED"
  currentBmcId   String?               @db.ObjectId
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  loads TankerLoad[]

  @@unique([organizationId, tankerNumber])
  @@index([status])
  @@index([organizationId])
}

model TankerLoad {
  id             String               @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String               @db.ObjectId
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tankerId       String               @db.ObjectId
  tanker         Tanker               @relation(fields: [tankerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  bmcId          String               @db.ObjectId
  bmc            MilkCollectionCenter @relation(fields: [bmcId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  dispatchDate   DateTime
  totalMilk      Float // Total liters loaded
  avgFat         Float
  avgSnf         Float
  avgClr         Float
  loadedAt       DateTime             @default(now())
  status         String               @default("LOADED") // "LOADED", "IN_TRANSIT", "DELIVERED"

  // Security fields for dairy entry
  challanNumber       String?
  vehicleNumber       String?
  grossWeight         Float?
  tareWeight          Float?
  netMilkWeight       Float?
  securityCheckedAt   DateTime?
  securityCheckedById String?   @db.ObjectId
  securityRemarks     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dairyReceipt DairyMilkReceipt?

  @@index([tankerId])
  @@index([bmcId])
  @@index([status])
  @@index([organizationId])
}

model DairyMilkReceipt {
  id                 String                @id @default(auto()) @map("_id") @db.ObjectId
  organizationId     String                @db.ObjectId
  organization       Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tankerLoadId       String                @unique @db.ObjectId
  tankerLoad         TankerLoad            @relation(fields: [tankerLoadId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  receivedAt         DateTime              @default(now())
  receivedMilk       Float // Liters received at dairy
  fat                Float
  snf                Float
  clr                Float
  qcStatus           String // "PASS" or "FAIL"
  qcNotes            String?
  gatePassNumber     String?
  procurementEntryId String?               @db.ObjectId
  procurementEntry   MilkProcurementEntry? @relation(fields: [procurementEntryId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  createdAt          DateTime              @default(now())

  @@index([organizationId])
}

model DirectDairyReceipt {
  id                 String                @id @default(auto()) @map("_id") @db.ObjectId
  organizationId     String                @db.ObjectId
  organization       Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customerId         String                @db.ObjectId
  customer           Connection            @relation(fields: [customerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  date               DateTime
  session            String // "morning" or "evening"
  receivedMilk       Float // Liters received at dairy
  fat                Float
  snf                Float
  clr                Float
  ratePerLiter       Float
  totalAmount        Float
  qcStatus           String? // "PASS" or "FAIL"
  qcNotes            String?
  procurementEntryId String?               @unique @db.ObjectId
  procurementEntry   MilkProcurementEntry? @relation(fields: [procurementEntryId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt

  @@index([organizationId])
  @@index([customerId])
  @@index([date])
}

model PaymentLedger {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  entityType     String // "CUSTOMER", "MANDALI", "BMC"
  entityId       String       @db.ObjectId
  periodStart    DateTime
  periodEnd      DateTime
  totalAmount    Float
  paidAmount     Float        @default(0)
  status         String       @default("PENDING") // "PENDING", "PARTIAL", "PAID"
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  customerPayments CustomerPayment[]
  mandaliPayments  MandaliPayment[]
  bmcPayments      BMCPayment[]

  @@index([entityType, entityId])
  @@index([status])
  @@index([organizationId])
}

model CustomerPayment {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  organizationId   String        @db.ObjectId
  organization     Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ledgerId         String        @db.ObjectId
  ledger           PaymentLedger @relation(fields: [ledgerId], references: [id], onDelete: Cascade)
  customerId       String        @db.ObjectId
  customer         Connection    @relation(fields: [customerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  collectionIds    String[]      @db.ObjectId // Array of CustomerMilkCollection IDs
  directReceiptIds String[]      @db.ObjectId // Array of DirectDairyReceipt IDs
  amount           Float
  paidAt           DateTime?
  createdAt        DateTime      @default(now())

  @@index([customerId])
  @@index([organizationId])
}

model MandaliPayment {
  id             String               @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String               @db.ObjectId
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ledgerId       String               @db.ObjectId
  ledger         PaymentLedger        @relation(fields: [ledgerId], references: [id], onDelete: Cascade)
  mandaliId      String               @db.ObjectId
  mandali        MilkCollectionCenter @relation(fields: [mandaliId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  summaryIds     String[]             @db.ObjectId // Array of MandaliSessionSummary IDs
  baseAmount     Float
  commission     Float // Commission earned by Mandali
  deductions     Float                @default(0) // Any deductions
  totalAmount    Float
  paidAt         DateTime?
  createdAt      DateTime             @default(now())

  @@index([mandaliId])
  @@index([organizationId])
}

model BMCPayment {
  id                 String               @id @default(auto()) @map("_id") @db.ObjectId
  organizationId     String               @db.ObjectId
  organization       Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ledgerId           String               @db.ObjectId
  ledger             PaymentLedger        @relation(fields: [ledgerId], references: [id], onDelete: Cascade)
  bmcId              String               @db.ObjectId
  bmc                MilkCollectionCenter @relation(fields: [bmcId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  collectionIds      String[]             @db.ObjectId // Array of BMCMilkCollection IDs
  baseAmount         Float
  transportDeduction Float                @default(0)
  otherDeductions    Float                @default(0)
  totalAmount        Float
  paidAt             DateTime?
  createdAt          DateTime             @default(now())

  @@index([bmcId])
  @@index([organizationId])
}

// Production
model ProductionBatch {
  id                String                @id @default(auto()) @map("_id") @db.ObjectId
  organizationId    String                @db.ObjectId
  organization      Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  batchNumber       String                @unique
  productId         String                @db.ObjectId
  product           Product               @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  producedQty       Float
  productionDate    DateTime
  manufacturingDate DateTime?
  expiryDate        DateTime?
  status            String                @default("IN_PRODUCTION") // e.g., "IN_PRODUCTION", "COMPLETED"
  remarks           String?               // Field to store rejection reason or notes
  items             ProductionBatchItem[]
  orderItems        OrderItem[]
  inventoryStocks   InventoryStock[]
  massComplaints    MassComplaint[]

  // Link to production plan
  productionPlanId String?              @db.ObjectId
  productionPlan   ProductionPlan?      @relation("PlanBatches", fields: [productionPlanId], references: [id], onDelete: SetNull)
  planItems        ProductionPlanItem[] @relation("PlanItemBatch")
}

model ProductionBatchItem {
  id           String          @id @default(auto()) @map("_id") @db.ObjectId
  batchId      String          @db.ObjectId
  batch        ProductionBatch @relation(fields: [batchId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  productId    String          @db.ObjectId
  product      Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  rawMilkUsedL Float?
  quantity     Float
}

// Recipe & BOM (Bill of Materials)
model Recipe {
  id              String             @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String             @db.ObjectId
  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name            String // e.g., "Standard Paneer", "Misti Doi"
  productCategory String // e.g., "PANEER", "CURD", "GHEE"
  outputUnit      String // e.g., "KG", "LITRE"
  outputQuantity  Float              @default(1) // Standard output (e.g., 1 KG)
  description     String?
  processTimeMins Int? // Total process time in minutes
  minFatPercent   Float? // Minimum fat % required in input milk
  minSnfPercent   Float? // Minimum SNF % required
  expectedYield   Float? // Expected yield percentage (e.g., 85 for 85%)
  processSteps    String? // JSON or text describing process steps
  isActive        Boolean            @default(true)
  isDefault       Boolean            @default(false) // Mark as default recipe for category
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  ingredients     RecipeIngredient[]
}

model RecipeIngredient {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  recipeId       String  @db.ObjectId
  recipe         Recipe  @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredientName String // e.g., "Raw Milk", "Citric Acid", "Culture"
  ingredientType String // e.g., "RAW_MATERIAL", "CULTURE", "ADDITIVE"
  quantity       Float // Quantity needed
  unit           String // e.g., "LITRE", "GRAM", "ML"
  isOptional     Boolean @default(false)
  notes          String? // e.g., "Use fresh culture only"
}

// Quality control
model QualityTest {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  testDate       DateTime
  testedById     String?      @db.ObjectId
  testedBy       User?        @relation(fields: [testedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  targetType     String // e.g., "RawMilk", "Batch", "InProcess"
  targetId       String? // reference id
  parameters     Json? // JSON field
  outcome        String // e.g., "PASS", "FAIL", "CONDITIONAL"
  remarks        String?
}

// Sales pipeline
model SalesInquiry {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inquiryNumber  String       @unique
  connectionId   String       @db.ObjectId
  connection     Connection   @relation(fields: [connectionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  productId      String?      @db.ObjectId
  product        Product?     @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  quantity       Float?
  quotedPrice    Float?
  status         String?
  source         String?
  createdAt      DateTime     @default(now())
}

model Quotation {
  id               String          @id @default(auto()) @map("_id") @db.ObjectId
  organizationId   String          @db.ObjectId
  organization     Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quoteRef         String          @unique
  connectionId     String          @db.ObjectId
  connection       Connection      @relation(fields: [connectionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subtotal         Float
  gstCGST          Float?
  gstSGST          Float?
  gstIGST          Float?
  discount         Float?
  transportCharges Float?
  coldChainCharges Float?
  deliveryTerms    String?
  paymentTerms     String?
  status           String?
  createdAt        DateTime        @default(now())
  lineItems        QuoteLineItem[]
}

model QuoteLineItem {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  quotationId String    @db.ObjectId
  productId   String    @db.ObjectId
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  qty         Float
  unitPrice   Float
  totalPrice  Float
}

enum OrderSource {
  MANUAL
  POS
  B2B
}

model SalesOrder {
  id                  String               @id @default(auto()) @map("_id") @db.ObjectId
  organizationId      String               @db.ObjectId
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  orderRef            String               @unique
  connectionId        String               @db.ObjectId
  connection          Connection           @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  stage               String?
  source              OrderSource?         @default(MANUAL)
  deliveryAddress     String?
  distanceKm          Float?
  vehicleReq          String?
  deliveryDate        DateTime? // Customer requested delivery date
  createdAt           DateTime             @default(now())
  updatedAt           DateTime?            @updatedAt
  items               OrderItem[]
  invoices            Invoice[]
  productionPlanItems ProductionPlanItem[] @relation("OrderPlanItems")
  deliveryChallans    DeliveryChallan[]
}

model OrderItem {
  id                  String               @id @default(auto()) @map("_id") @db.ObjectId
  organizationId      String               @db.ObjectId
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesOrder          SalesOrder           @relation(fields: [salesOrderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  salesOrderId        String               @db.ObjectId
  productId           String               @db.ObjectId
  product             Product              @relation(fields: [productId], references: [id], onDelete: Cascade)
  qty                 Float
  price               Float
  batchId             String?              @db.ObjectId
  batch               ProductionBatch?     @relation(fields: [batchId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  mfgDate             DateTime?
  expiryDate          DateTime?
  productionPlanItems ProductionPlanItem[] @relation("OrderItemPlan")
}

model Invoice {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoiceNumber  String
  salesOrderId   String?      @db.ObjectId
  salesOrder     SalesOrder?  @relation(fields: [salesOrderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  dueDate        DateTime?
  invoiceDate    DateTime?     @default(now()) // Invoice date

  // Amount Breakdown
  subtotal        Float  @default(0) // Total before tax
  discountAmount  Float  @default(0) // Discount amount
  discountPercent Float? @default(0) // Discount percentage

  // GST Tax Breakdown
  taxableAmount  Float  @default(0) // Amount on which tax is calculated
  cgstRate       Float? @default(0) // CGST rate percentage
  cgstAmount     Float  @default(0) // CGST amount
  sgstRate       Float? @default(0) // SGST rate percentage
  sgstAmount     Float  @default(0) // SGST amount
  igstRate       Float? @default(0) // IGST rate percentage
  igstAmount     Float  @default(0) // IGST amount
  cessAmount     Float  @default(0) // Cess amount (if applicable)
  totalTaxAmount Float  @default(0) // Total tax (CGST+SGST or IGST + Cess)

  // Rounding and Final Amount
  roundOff      Float   @default(0) // Round-off amount (+/-)
  totalAmount   Float // Final invoice amount
  amountInWords String? // Amount in words (e.g., "INR Two Lakh Five Thousand Only")

  paidAmount    Float   @default(0)
  balanceAmount Float   @default(0) // totalAmount - paidAmount
  status        String?

  // Invoice Type
  invoiceType       String  @default("TAX_INVOICE") // TAX_INVOICE, BILL_OF_SUPPLY, PROFORMA
  supplyType        String  @default("B2B") // B2B, B2C, SEZWOP, SEZWP, DEEMED_EXPORT
  isInterState      Boolean @default(false) // true = IGST, false = CGST+SGST
  placeOfSupply     String? // Place/State of supply
  placeOfSupplyCode String? // State code of place of supply

  // E-Way Bill
  eWayBillNumber  String? // E-Way Bill number (if applicable)
  eWayBillDate    DateTime? // E-Way Bill generation date
  vehicleNumber   String? // Vehicle number for transport
  transportMode   String? // ROAD, RAIL, AIR, SHIP
  transporterName String? // Transporter name
  transporterId   String? // Transporter GST ID
  lrNumber        String? // LR/RR/Airway Bill number

  // Other References
  poNumber       String? // Customer PO number
  poDate         DateTime? // Customer PO date
  challanNumber  String? // Delivery challan reference
  otherReference String? // Any other reference

  // IRN for E-Invoicing (GST)
  irn          String? // Invoice Reference Number
  irnAckNumber String? // IRN acknowledgement number
  irnAckDate   DateTime? // IRN acknowledgement date
  qrCodeData   String? // QR Code data for GST
  signedQrCode String? // Signed QR Code

  // Approval workflow fields
  approvalStatus  String    @default("DRAFT") // DRAFT, PENDING_APPROVAL, APPROVED, REJECTED
  approvedById    String?   @db.ObjectId
  approvedAt      DateTime?
  rejectionReason String?

  // Customer/Buyer Billing Details (copied from connection at invoice time)
  customerGstNumber String?
  customerName      String?
  customerAddress   String?
  customerCity      String?
  customerState     String?
  customerStateCode String? // State code for GST
  customerPincode   String?
  customerPhone     String?

  // Shipping Address (if different from billing)
  shipToName      String?
  shipToAddress   String?
  shipToCity      String?
  shipToState     String?
  shipToStateCode String?
  shipToPincode   String?

  // Seller Details (snapshot from organization)
  sellerName      String?
  sellerAddress   String?
  sellerCity      String?
  sellerState     String?
  sellerStateCode String?
  sellerPincode   String?
  sellerGstNumber String?
  sellerPanNumber String?

  // Invoice notes and terms
  notes              String?
  termsAndConditions String?
  
  // Auto-generation tracking
  autoGenerated Boolean @default(false)
  emailSent     Boolean @default(false)
  emailSentAt   DateTime?
  
  // Payment tracking
  paymentMethod    String? // CASH, UPI, CARD, NEFT, RTGS, CHEQUE
  paymentReference String? // Transaction ID / Cheque number
  paymentDate      DateTime?
  
  // Tally export tracking
  tallyExported      Boolean   @default(false)
  tallyExportedAt    DateTime?
  tallyVoucherNumber String?
  
  // Source tracking
  source String? // 'B2B', 'POS', 'CRM', 'MANUAL'
  declaration        String? // Declaration text

  // Quantity Summary
  totalQuantity Float? @default(0) // Total quantity of items

  // Email tracking
  sentToCustomer Boolean       @default(false)
  sentAt         DateTime?
  customerEmail  String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  payments       Payment[]
  items          InvoiceItem[]

  @@unique([organizationId, invoiceNumber])
}

// Invoice Line Item - Detailed breakdown per product with tax
model InvoiceItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  invoiceId String  @db.ObjectId
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Product Details (snapshot at invoice time)
  productId          String? @db.ObjectId
  productName        String // Product name
  productDescription String? // Product description
  hsnCode            String? // HSN/SAC code
  sku                String? // SKU code

  // Quantity and Unit
  quantity Float // Quantity
  unit     String // Unit of measurement (KG, LITRE, PIECE, etc.)
  unitName String? // Full unit name for display

  // Pricing
  mrp             Float? // Maximum Retail Price
  rateBeforeTax   Float // Rate before tax per unit
  rateAfterTax    Float? // Rate including tax per unit
  discountPercent Float  @default(0) // Discount percentage
  discountAmount  Float  @default(0) // Discount amount

  // Taxable Value
  taxableValue Float // Quantity * Rate - Discount

  // GST Breakdown
  gstRate    Float @default(0) // GST rate percentage
  cgstRate   Float @default(0) // CGST rate (half of GST)
  cgstAmount Float @default(0) // CGST amount
  sgstRate   Float @default(0) // SGST rate (half of GST)
  sgstAmount Float @default(0) // SGST amount
  igstRate   Float @default(0) // IGST rate (full GST for inter-state)
  igstAmount Float @default(0) // IGST amount

  // Cess (if applicable)
  cessRate   Float @default(0) // Cess rate percentage
  cessAmount Float @default(0) // Cess amount

  // Total
  totalTaxAmount Float @default(0) // Total tax on this item
  totalAmount    Float // Total amount including tax

  // Batch and Expiry (optional)
  batchNumber String? // Batch number
  mfgDate     DateTime? // Manufacturing date
  expiryDate  DateTime? // Expiry date

  // Serial number in invoice
  serialNumber Int? // Line item serial number (1, 2, 3...)

  createdAt DateTime @default(now())

  @@index([invoiceId])
}

model Payment {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoiceId      String?      @db.ObjectId
  invoice        Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  amount         Float
  method         String
  referenceNo    String?
  bankName       String?
  paidAt         DateTime
  status         String?
  direction      String       @default("IN") // IN | OUT
  categoryId     String?      @db.ObjectId
  linkedType     String?
  linkedId       String?
  particulars    String?
  notes          String?
  createdById    String?      @db.ObjectId
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId, direction, paidAt])
  @@index([linkedType, linkedId])
  @@index([categoryId])
}

model DeliveryChallan {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId   String       @db.ObjectId
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  challanNumber    String       @unique
  salesOrderId     String?      @db.ObjectId
  salesOrder       SalesOrder?  @relation(fields: [salesOrderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  vehicleNumber    String?
  driverName       String?
  driverPhone      String?
  routeNumber      Int? // Numeric route (e.g., 1, 2, 3)
  dispatchTime     DateTime? // Time when dispatch started
  estimatedArrival DateTime? // Estimated arrival time
  actualArrival    DateTime? // Actual arrival time
  tempInitialC     Float?
  tempFinalC       Float?
  signedBy         String?
  deliveredAt      DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

// Inventory
model StorageLocation {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String           @db.ObjectId
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  type           String // Cold Room / Freezer / Refrigerated Warehouse
  capacity       Float?
  currentLoad    Float?           @default(0)
  tempMin        Float?
  tempMax        Float?
  currentTemp    Float?
  operational    Boolean?         @default(true)
  maintenanceLog Json? // JSON field
  stocks         InventoryStock[]
  dailyStockRecords DailyStockRecord[]
}

model InventoryStock {
  id                String                 @id @default(auto()) @map("_id") @db.ObjectId
  organizationId    String                 @db.ObjectId
  organization      Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  productId         String                 @db.ObjectId
  product           Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
  batchId           String?                @db.ObjectId
  batch             ProductionBatch?       @relation(fields: [batchId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  storageLocationId String                 @db.ObjectId
  storageLocation   StorageLocation        @relation(fields: [storageLocationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  quantity          Float
  mfgDate           DateTime?
  expiryDate        DateTime?
  createdAt         DateTime               @default(now())
  txns              InventoryTransaction[]
}

model InventoryTransaction {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String         @db.ObjectId
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stockId        String         @db.ObjectId
  stock          InventoryStock @relation(fields: [stockId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  type           String // e.g., "IN", "OUT", "ADJUSTMENT"
  qty            Float
  referenceType  String? // e.g., "SalesOrder", "ProductionBatch"
  referenceId    String?
  reason         String? // Description/Return reason
  createdAt      DateTime       @default(now())
}

model DailyStockRecord {
  id              String                @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String                @db.ObjectId
  organization    Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  productId       String                @db.ObjectId
  product         Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  locationId      String?               @db.ObjectId
  location        StorageLocation?      @relation(fields: [locationId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  mandaliId       String?               @db.ObjectId
  mandali         MilkCollectionCenter? @relation(fields: [mandaliId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  date            DateTime
  session         String? // "morning" or "evening"

  // Stock movement
  openingStock    Float     @default(0)
  received        Float     @default(0)
  dispatched      Float     @default(0)
  wastage         Float     @default(0)
  adjustments     Float     @default(0)
  closingStock    Float     @default(0)
  expectedClosing Float     @default(0)
  variance        Float     @default(0)

  // Quality parameters
  avgFat          Float?
  avgSnf          Float?
  temperature     Float?

  // Financials
  ratePerUnit     Float?
  openingValue    Float?
  closingValue    Float?

  // Metadata
  remarks         String?
  recordedById    String?   @db.ObjectId
  recordedBy      User?     @relation("RecordedDailyStocks", fields: [recordedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  verifiedById    String?   @db.ObjectId
  verifiedBy      User?     @relation("VerifiedDailyStocks", fields: [verifiedById], references: [id], onDelete: NoAction, onUpdate: NoAction)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([organizationId, productId, locationId, date, session])
  @@index([organizationId])
  @@index([productId])
  @@index([date])
}

// Material Requests
model MaterialRequest {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requestedById  String       @db.ObjectId
  requestedBy    User         @relation(fields: [requestedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  productId      String?      @db.ObjectId
  product        Product?     @relation(fields: [productId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  material       String? // Material name (if not a product)
  quantity       Float
  unit           String // e.g., "KG", "L", "PIECE"
  priority       String? // e.g., "LOW", "MEDIUM", "HIGH", "URGENT"
  status         String       @default("PENDING") // PENDING, APPROVED, REJECTED, FULFILLED, CANCELLED
  notes          String?
  requestedDate  DateTime     @default(now())
  fulfilledDate  DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model PurchaseOrder {
  id                   String                          @id @default(auto()) @map("_id") @db.ObjectId
  organizationId       String                          @db.ObjectId
  organization         Organization                    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  poRef                String                          @unique
  type                 String
  supplierId           String                          @db.ObjectId
  supplier             Connection                      @relation(fields: [supplierId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  expectedDate         DateTime?
  actualDate           DateTime?
  status               String                          @default("DRAFT") // DRAFT, SENT, CONFIRMED, RECEIVED, CANCELLED
  totalAmount          Float?                          // Computed from items
  receivedDate         DateTime?
  markedAsPurchase     Boolean                         @default(false)
  notes                String?
  expenseId            String?                         @db.ObjectId // Link to auto-generated expense
  createdAt            DateTime                        @default(now())
  updatedAt            DateTime                        @updatedAt
  items                POItem[]
  materialRequirements ProductionMaterialRequirement[] @relation("MaterialPO")

  @@index([organizationId])
  @@index([status])
}

model POItem {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  purchaseOrderId String        @db.ObjectId
  description     String
  qty             Float
  unitPrice       Float
  productId       String?       @db.ObjectId // Link to raw material product for stock updates
  product         Product?      @relation("POItemProduct", fields: [productId], references: [id], onDelete: SetNull, onUpdate: NoAction)
}

model Bill {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  billNumber     String       @unique
  supplierId     String       @db.ObjectId
  supplier       Connection   @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  dueDate        DateTime?
  amount         Float
  paidAmount     Float        @default(0)
  status         String?
}

model SupportTicket {
  id             String          @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String          @db.ObjectId
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ticketNumber   String          @unique
  connectionId   String?         @db.ObjectId
  connection     Connection?     @relation(fields: [connectionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  issueType      String
  priority       String // e.g., "LOW", "MEDIUM", "HIGH", "CRITICAL"
  status         String // e.g., "OPEN", "IN_PROGRESS", "RESOLVED", "CLOSED"
  createdAt      DateTime        @default(now())
  comments       TicketComment[]
}

model TicketComment {
  id         String        @id @default(auto()) @map("_id") @db.ObjectId
  ticketId   String        @db.ObjectId
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  authorId   String?       @db.ObjectId
  author     User?         @relation(fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  content    String
  isInternal Boolean       @default(false)
  createdAt  DateTime      @default(now())
}

model SupplierFeedback {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  supplierId     String       @db.ObjectId
  supplier       Connection   @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  feedbackType   String
  details        String?
  resolved       Boolean      @default(false)
}

model Activity {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?      @db.ObjectId
  user           User?        @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  type           String
  notes          String?
  relatedType    String?
  relatedId      String?
  createdAt      DateTime     @default(now())
}

model Document {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  path           String
  category       String?
  relatedType    String?
  relatedId      String?
  uploadedById   String?      @db.ObjectId
  uploadedBy     User?        @relation(fields: [uploadedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  uploadedAt     DateTime     @default(now())
}

model Notification {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  title          String
  body           String?
  isRead         Boolean      @default(false)
  taskId         String?      @db.ObjectId
  task           Task?        @relation("TaskNotifications", fields: [taskId], references: [id], onDelete: SetNull)
  // POS-related notification fields
  posAlertId     String?      @db.ObjectId
  posOrderId     String?      @db.ObjectId
  posInvoiceId   String?      @db.ObjectId
  materialId     String?      @db.ObjectId // For Inventory Shortfall
  createdAt      DateTime     @default(now())
}

model PushSubscription {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  endpoint       String       @unique
  p256dh         String
  auth           String
  userAgent      String?
  enabled        Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([userId, organizationId])
}

// Analytics & commission
model SalesTarget {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?      @db.ObjectId
  user           User?        @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  period         String
  amount         Float
  achieved       Float        @default(0)
}

model CommissionRule {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String       @db.ObjectId
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  productCategory String?
  minAmount       Float?
  maxAmount       Float?
  percentage      Float
}

model Commission {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?      @db.ObjectId
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  orderId        String?
  amount         Float
  paidStatus     String?
}

// Audit
model AuditLog {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?      @db.ObjectId
  user           User?        @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  action         String
  entity         String
  entityId       String?
  meta           Json? // JSON field
  createdAt      DateTime     @default(now())
}

// Email Verification
model VerificationToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  token     String   @unique
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// Magic Link Login
model MagicLinkToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  token     String   @unique
  userId    String   @db.ObjectId
  user      User     @relation("MagicLinkTokens", fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// Password Reset Token
model PasswordResetToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  tokenHash String   @unique
  userId    String   @db.ObjectId
  user      User     @relation("PasswordResetTokens", fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// Email Verification Token (with hashed token)
model EmailVerificationToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  tokenHash String   @unique
  userId    String   @db.ObjectId
  user      User     @relation("EmailVerificationTokens", fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// Organization Invitations
model OrganizationInvite {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String // "ADMIN" or "MEMBER"
  userRole       String? // Functional role key (e.g., "10" for HR, "3" for QC, "13" for POS_OWNER)
  invitedById    String       @db.ObjectId
  invitedBy      User         @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)
  token          String       @unique
  status         String       @default("PENDING") // "PENDING", "ACCEPTED", "CANCELLED", "EXPIRED"
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Invite Type: MEMBER (default), POS_OWNER, VENDOR
  inviteType String @default("MEMBER")

  // Connection invite (for vendor invites)
  connectionId String?     @db.ObjectId
  connection   Connection? @relation("ConnectionInvite", fields: [connectionId], references: [id], onDelete: Cascade)

  // POS Location invite (for POS owner invites)
  posLocationId String?      @db.ObjectId
  posLocation   POSLocation? @relation("POSLocationInvite", fields: [posLocationId], references: [id], onDelete: Cascade)
}

// Gate Entry (Gate Operator workflow)
model GateEntry {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId   String       @db.ObjectId
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  entryNumber      String       @unique
  vehicleNumber    String
  supplierId       String?      @db.ObjectId
  supplier         Connection?  @relation(fields: [supplierId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  entryTime        DateTime
  expectedQuantity Float? // Expected quantity in litres
  actualQuantity   Float? // Actual quantity received
  driverName       String?
  driverPhone      String?
  status           String       @default("PENDING") // PENDING, RECEIVED, REJECTED
  remarks          String?
  createdById      String?      @db.ObjectId
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

// Mass Complaining (replaces Market Returns)
model MassComplaint {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String           @db.ObjectId
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  complaintNumber String           @unique
  customerId      String?          @db.ObjectId
  customer        Connection?      @relation(fields: [customerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  salesOrderId    String?          @db.ObjectId // Link to B2B order (for vendor complaints)
  productId       String?          @db.ObjectId
  product         Product?         @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  batchId         String?          @db.ObjectId
  batch           ProductionBatch? @relation(fields: [batchId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  issueType       String // e.g., "POUCH_LEAKAGE", "SOUR_CURD", "PANEER_DEFECT", "EXPIRED", "DELIVERY_ISSUE", "WRONG_ITEMS", "OTHER"
  quantity        Float // Quantity affected
  description     String?
  complaintDate   DateTime
  status          String           @default("OPEN") // OPEN, INVESTIGATING, RESOLVED, CLOSED
  resolution      String?
  resolvedAt      DateTime?
  creditNoteId    String?
  totalAmount     Float? // Refund/credit amount
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model ComplaintIssueType {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  isActive       Boolean      @default(true)
  isSystem       Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, name])
  @@index([organizationId])
}

// Festival Data for spike calculations
model FestivalData {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  festival       String // e.g., "Diwali", "Holi", "Eid"
  festivalDate   DateTime
  year           Int
  productId      String?      @db.ObjectId
  product        Product?     @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  quantity       Float // Quantity produced/sold during festival
  unit           String // e.g., "LITRE", "KG"
  extraPercent   Float? // Extra percentage increase
  extraQuantity  Float? // Extra quantity
  keyProducts    Json? // Array of key products
  recommendation String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

// Workflow Status Tracking
model WorkflowStatus {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  entityType     String // e.g., "GATE_ENTRY", "PROCUREMENT", "PRODUCTION_BATCH", "DISPATCH"
  entityId       String       @db.ObjectId
  currentStage   String // e.g., "GATE_ENTRY", "STORE", "QC", "PRODUCTION", "DISPATCH", "FINANCE", "MANAGEMENT"
  status         String       @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, BLOCKED, REJECTED
  assignedTo     String? // Role or user ID
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([entityType, entityId])
  @@index([organizationId, currentStage])
}

// Maintenance
model Machine {
  id                  String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId      String       @db.ObjectId
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name                String
  type                String // e.g. "PASTEURIZER", "CHILLER"
  status              String       @default("OPERATIONAL") // "OPERATIONAL", "BREAKDOWN", "MAINTENANCE"
  efficiency          Float?       @default(100)
  lastMaintenanceDate DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

// HR
model Attendance {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  date           DateTime
  status         String // "PRESENT", "ABSENT", "LEAVE", "HALF_DAY"
  checkInTime    DateTime?
  checkOutTime   DateTime?
  hoursWorked    Float?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model LeaveRequest {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  startDate      DateTime
  endDate        DateTime
  reason         String?
  status         String       @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  approvedById   String?      @db.ObjectId
  approvedBy     User?        @relation("LeaveApprover", fields: [approvedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Shift {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String // e.g. "Morning", "Evening", "Night"
  startTime      String // "06:00"
  endTime        String // "14:00"
  users          User[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, name])
}

// WhatsApp Contacts for Procurement
model WhatsAppContact {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  phoneNumber    String
  connectionId   String?      @db.ObjectId
  connection     Connection?  @relation(fields: [connectionId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, phoneNumber])
  @@index([organizationId])
  @@index([phoneNumber])
}

// Margin Management Models
// Customer default margin - applies to all products for this customer
model CustomerMargin {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  connectionId   String       @unique @db.ObjectId // Customer connection
  connection     Connection   @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  marginPercent  Float // Default margin % for this customer (e.g., 10 = 10%)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
}

// Product global margin - applies to all customers
model ProductMargin {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  productId      String       @unique @db.ObjectId
  product        Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  marginPercent  Float // Global margin % for this product
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
}

// Customer-specific product margin (override)
model CustomerProductMargin {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  connectionId   String       @db.ObjectId // Customer connection
  connection     Connection   @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  productId      String       @db.ObjectId
  product        Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  marginPercent  Float // Override margin % for this customer-product combo
  // Target price support (bidirectional calculation)
  targetPrice    Float? // If set, discount is calculated from markedPrice
  calculatedFrom String? // "DISCOUNT" or "TARGET_PRICE" - which was set manually
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([connectionId, productId]) // One margin per customer-product pair
  @@index([organizationId])
}

// ==========================================
// Production Planning System
// ==========================================

// ProductionPlan: Master planning document for production scheduling
// Links orders to production batches and manages material requirements
model ProductionPlan {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planNumber     String       @unique // e.g., "PP-2026-001"
  name           String? // Optional plan name
  plannedDate    DateTime // When production is planned
  startDate      DateTime? // Actual start date
  endDate        DateTime? // Actual/expected end date
  status         String       @default("DRAFT") // DRAFT, APPROVED, IN_PROGRESS, COMPLETED, CANCELLED
  priority       String       @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  notes          String?
  createdById    String?      @db.ObjectId
  createdBy      User?        @relation("ProductionPlanCreator", fields: [createdById], references: [id], onDelete: SetNull)
  approvedById   String?      @db.ObjectId
  approvedBy     User?        @relation("ProductionPlanApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  items                ProductionPlanItem[]
  materialRequirements ProductionMaterialRequirement[]
  productionBatches    ProductionBatch[]               @relation("PlanBatches")
  stockAlerts          StockAlert[]                    @relation("PlanAlerts")

  @@index([organizationId])
  @@index([plannedDate])
  @@index([status])
}

// ProductionPlanItem: Individual product targets in a production plan
// Can be linked to sales orders (demand-driven) or standalone (forecast-driven)
model ProductionPlanItem {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  productionPlanId String         @db.ObjectId
  productionPlan   ProductionPlan @relation(fields: [productionPlanId], references: [id], onDelete: Cascade)
  productId        String         @db.ObjectId
  product          Product        @relation("PlanProducts", fields: [productId], references: [id], onDelete: Cascade)
  targetQuantity   Float // Quantity to produce
  producedQuantity Float          @default(0) // Actual quantity produced
  unit             String // e.g., "KG", "LITRE", "PIECE"
  priority         String         @default("MEDIUM")
  status           String         @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED
  notes            String?

  // Link to sales order (optional - for demand-driven production)
  salesOrderId String?     @db.ObjectId
  salesOrder   SalesOrder? @relation("OrderPlanItems", fields: [salesOrderId], references: [id], onDelete: SetNull)
  orderItemId  String?     @db.ObjectId
  orderItem    OrderItem?  @relation("OrderItemPlan", fields: [orderItemId], references: [id], onDelete: SetNull)

  // Link to production batch when production starts
  productionBatchId String?          @db.ObjectId
  productionBatch   ProductionBatch? @relation("PlanItemBatch", fields: [productionBatchId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productionPlanId])
  @@index([productId])
  @@index([salesOrderId])
}

// ProductionMaterialRequirement: Raw materials and supplies needed for production
// Links suppliers (connections) to production plans for sourcing
model ProductionMaterialRequirement {
  id                String         @id @default(auto()) @map("_id") @db.ObjectId
  productionPlanId  String         @db.ObjectId
  productionPlan    ProductionPlan @relation(fields: [productionPlanId], references: [id], onDelete: Cascade)
  materialName      String // e.g., "Raw Milk", "Citric Acid", "Packaging Material"
  materialType      String // RAW_MATERIAL, PACKAGING, ADDITIVE, CULTURE, OTHER
  productId         String?        @db.ObjectId // If material is a tracked product
  product           Product?       @relation("MaterialProduct", fields: [productId], references: [id], onDelete: SetNull)
  requiredQuantity  Float // Total quantity needed
  availableQuantity Float          @default(0) // Current available stock
  orderedQuantity   Float          @default(0) // Quantity ordered from suppliers
  receivedQuantity  Float          @default(0) // Quantity received
  unit              String // e.g., "LITRE", "KG", "PIECE"
  estimatedCost     Float?
  actualCost        Float?
  status            String         @default("PENDING") // PENDING, ORDERED, PARTIAL, FULFILLED, SHORTAGE
  requiredByDate    DateTime? // When material is needed

  // Link to preferred supplier (connection)
  supplierId String?     @db.ObjectId
  supplier   Connection? @relation("MaterialSupplier", fields: [supplierId], references: [id], onDelete: SetNull)

  // Link to purchase order (when created)
  purchaseOrderId String?        @db.ObjectId
  purchaseOrder   PurchaseOrder? @relation("MaterialPO", fields: [purchaseOrderId], references: [id], onDelete: SetNull)

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productionPlanId])
  @@index([supplierId])
  @@index([status])
}

// StockAlert: Automated stock level alerts based on production requirements
model StockAlert {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  alertType      String // LOW_STOCK, OUT_OF_STOCK, REORDER_POINT, PRODUCTION_SHORTAGE
  severity       String       @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  status         String       @default("ACTIVE") // ACTIVE, ACKNOWLEDGED, RESOLVED, IGNORED

  // What triggered the alert
  productId    String?  @db.ObjectId
  product      Product? @relation("ProductAlerts", fields: [productId], references: [id], onDelete: Cascade)
  materialName String? // For non-product materials

  // Stock levels
  currentQuantity   Float // Current stock level
  minimumQuantity   Float // Minimum required/reorder level
  requiredQuantity  Float? // Additional quantity needed (e.g., for production plan)
  shortfallQuantity Float? // How much is short

  // Links to related entities
  productionPlanId String?         @db.ObjectId
  productionPlan   ProductionPlan? @relation("PlanAlerts", fields: [productionPlanId], references: [id], onDelete: SetNull)
  supplierId       String?         @db.ObjectId
  supplier         Connection?     @relation("AlertSupplier", fields: [supplierId], references: [id], onDelete: SetNull)

  // Alert details
  title            String
  message          String
  acknowledgedById String?   @db.ObjectId
  acknowledgedBy   User?     @relation("AlertAcknowledger", fields: [acknowledgedById], references: [id], onDelete: SetNull)
  acknowledgedAt   DateTime?
  resolvedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([alertType])
  @@index([productId])
}

// ==========================================
// E-commerce Catalog & Inquiry System
// ==========================================

// Product Images - Multiple images per product with Azure Blob Storage
model ProductImage {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  productId      String       @db.ObjectId
  product        Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  url            String // Azure Blob Storage URL
  altText        String? // Alt text for accessibility
  isPrimary      Boolean      @default(false) // Primary display image
  order          Int          @default(0) // Display order
  createdAt      DateTime     @default(now())

  @@index([productId])
  @@index([organizationId])
}

// Product Category - Hierarchical categories for catalog navigation
model ProductCategory {
  id             String            @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String            @db.ObjectId
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String // e.g., "Dairy Products", "Ghee & Butter"
  slug           String // URL-friendly: "dairy-products"
  description    String?
  iconUrl        String? // Category icon (Azure Blob Storage)
  parentId       String?           @db.ObjectId // For sub-categories
  parent         ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children       ProductCategory[] @relation("CategoryHierarchy")
  order          Int               @default(0) // Display order
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  products       Product[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([parentId])
}

// Public Inquiry - Anonymous visitor inquiries from catalog
model PublicInquiry {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inquiryNumber  String       @unique // Auto-generated: INQ-2026-0001

  // Visitor Details
  visitorName  String
  visitorEmail String
  visitorPhone String?
  companyName  String? // Optional business name

  // Inquiry Details
  productId        String?  @db.ObjectId
  product          Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  categoryInterest String? // Category they're interested in
  quantityInterest Float? // Approximate quantity needed
  message          String // Inquiry message

  // Tracking
  status       String  @default("NEW") // NEW, CONTACTED, CONVERTED, CLOSED
  source       String  @default("CATALOG") // CATALOG, DIRECT_LINK, REFERRAL
  assignedToId String? @db.ObjectId
  notes        String? // Internal notes

  // Conversion tracking
  convertedToInquiryId    String? @db.ObjectId // Link to SalesInquiry if converted
  convertedToConnectionId String? @db.ObjectId // Link to Connection if converted

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([productId])
  @@index([createdAt])
}

// ============================================
// POS INTEGRATION MODELS
// ============================================

// POS Location - Physical retail store/outlet managed by CRM
model POSLocation {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Basic Info
  name    String // "Downtown Store", "Mall Branch"
  code    String // Unique code like "POS001"
  address String?
  city    String?
  state   String?
  pincode String?

  // Contact Info
  contactPerson String?
  contactEmail  String // POS owner email
  contactPhone  String?

  // Status: PENDING (invited), ACTIVE, INACTIVE, SUSPENDED
  status String @default("PENDING")

  // Owner (set after invitation accepted)
  ownerId String? @db.ObjectId
  owner   User?   @relation("POSOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  // Financial Settings
  creditLimit      Float @default(0) // Credit limit in INR (0 = unlimited)
  currentBalance   Float @default(0) // Current outstanding balance
  paymentTermsDays Int   @default(30) // Payment due in X days

  // Pricing Settings
  useCustomPricing      Boolean @default(false)
  globalDiscountPercent Float?  @default(0) // Global discount for this POS

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  stockSettings POSProductStock[]
  customPricing POSProductPricing[]
  stockAlerts   POSStockAlert[]
  orders        POSOrder[]
  invoices      POSInvoice[]
  transactions  POSTransaction[]
  customers     POSCustomer[]        @relation("POSLocationCustomers")
  sessions      POSSession[]         @relation("POSLocationSessions")
  invites       OrganizationInvite[] @relation("POSLocationInvite")

  @@unique([organizationId, code])
  @@index([organizationId, status])
  @@index([ownerId])
}

// POS Product Stock - Minimum stock settings per product per POS
model POSProductStock {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  posLocationId String      @db.ObjectId
  posLocation   POSLocation @relation(fields: [posLocationId], references: [id], onDelete: Cascade)
  productId     String      @db.ObjectId
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  currentStock    Float @default(0) // Current stock quantity
  minimumStock    Float @default(10) // Alert threshold
  reorderQuantity Float @default(50) // Default order quantity

  lastStockUpdate DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([posLocationId, productId])
  @@index([posLocationId])
  @@index([productId])
}

// POS Product Pricing - Custom pricing per product per POS
model POSProductPricing {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  posLocationId String      @db.ObjectId
  posLocation   POSLocation @relation(fields: [posLocationId], references: [id], onDelete: Cascade)
  productId     String      @db.ObjectId
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  customPrice    Float? // Override selling price
  customDiscount Float? // Override discount %
  isActive       Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([posLocationId, productId])
  @@index([posLocationId])
}

// POS Stock Alert - Low stock alerts from POS to CRM
model POSStockAlert {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  posLocationId  String       @db.ObjectId
  posLocation    POSLocation  @relation(fields: [posLocationId], references: [id], onDelete: Cascade)
  productId      String       @db.ObjectId
  product        Product      @relation("POSStockAlertProduct", fields: [productId], references: [id], onDelete: Cascade)

  // Alert Details
  currentStock Float
  minimumStock Float
  shortfall    Float // minimumStock - currentStock
  alertType    String // LOW_STOCK, CRITICAL, OUT_OF_STOCK
  priority     String @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL

  // Status: PENDING, ACKNOWLEDGED, ORDER_CREATED, RESOLVED
  status String @default("PENDING")

  // Auto-created Order (if any)
  autoOrderId String? @db.ObjectId

  // Resolution
  acknowledgedById String?   @db.ObjectId
  acknowledgedBy   User?     @relation("POSAlertAcknowledger", fields: [acknowledgedById], references: [id])
  acknowledgedAt   DateTime?
  resolvedAt       DateTime?

  // Notification Tracking
  crmNotified Boolean @default(false)
  posNotified Boolean @default(false)
  emailSent   Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([organizationId, status])
  @@index([posLocationId, status])
  @@index([alertType, priority])
}

// POS Order - Orders from POS to CRM for stock replenishment
model POSOrder {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  posLocationId  String       @db.ObjectId
  posLocation    POSLocation  @relation(fields: [posLocationId], references: [id], onDelete: Cascade)

  // Order Info
  orderNumber String   @unique
  orderDate   DateTime @default(now())

  // Status: DRAFT, PENDING, CONFIRMED, PROCESSING, SHIPPED, DELIVERED, CANCELLED
  status String @default("DRAFT")

  // Source: MANUAL (POS created), AUTO_STOCK_ALERT (system created)
  creationType String  @default("MANUAL")
  stockAlertId String? @db.ObjectId // Reference to triggering alert

  // Financials
  subtotal       Float @default(0)
  discountAmount Float @default(0)
  taxAmount      Float @default(0)
  totalAmount    Float @default(0)

  // Delivery
  expectedDelivery DateTime?
  deliveredAt      DateTime?
  deliveryNotes    String?

  // Created By
  createdById String? @db.ObjectId
  createdBy   User?   @relation("POSOrderCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items   POSOrderItem[]
  invoice POSInvoice?

  @@index([organizationId, status])
  @@index([posLocationId, status])
}

// POS Order Item - Line items in a POS order
model POSOrderItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String   @db.ObjectId
  order     POSOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String   @db.ObjectId
  product   Product  @relation("POSOrderItemProduct", fields: [productId], references: [id])

  quantity   Float
  unitPrice  Float // Price at time of order
  discount   Float @default(0)
  taxRate    Float @default(0)
  totalPrice Float

  @@index([orderId])
}

// POS Invoice - Inter-company invoices for POS orders
model POSInvoice {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  posLocationId  String       @db.ObjectId
  posLocation    POSLocation  @relation(fields: [posLocationId], references: [id], onDelete: Cascade)
  orderId        String       @unique @db.ObjectId
  order          POSOrder     @relation(fields: [orderId], references: [id])

  // Invoice Info
  invoiceNumber String   @unique
  invoiceDate   DateTime @default(now())
  dueDate       DateTime

  // Status: DRAFT, SENT, PAID, PARTIAL, OVERDUE, CANCELLED
  status String @default("DRAFT")

  // Financials
  subtotal       Float
  discountAmount Float @default(0)
  taxAmount      Float @default(0)
  totalAmount    Float
  paidAmount     Float @default(0)
  balanceAmount  Float

  // Payment Info
  paymentDate   DateTime?
  paymentMethod String?
  paymentRef    String?
  notes         String?

  // Reminder tracking
  lastReminderSentAt DateTime?
  reminderCount      Int       @default(0)

  // Relations
  payments POSPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
  @@index([posLocationId, status])
  @@index([dueDate, status])
}

// POS Payment - Payment records for POS invoices
model POSPayment {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  invoiceId String     @db.ObjectId
  invoice   POSInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  amount        Float
  paymentMethod String // CASH, BANK_TRANSFER, UPI, CHEQUE
  paymentDate   DateTime @default(now())
  reference     String? // Transaction ID, cheque number, etc.
  notes         String?

  createdAt DateTime @default(now())

  @@index([invoiceId])
}

// POS Transaction - Retail sales transactions at POS location
model POSTransaction {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  posLocationId  String?      @db.ObjectId
  posLocation    POSLocation? @relation(fields: [posLocationId], references: [id], onDelete: SetNull)

  // Transaction Info
  receiptNumber   String   @unique
  transactionDate DateTime @default(now())
  status          String   @default("COMPLETED") // PENDING, COMPLETED, CANCELLED, REFUNDED

  // Customer Info (optional for walk-in)
  customerId    String?      @db.ObjectId
  customer      POSCustomer? @relation("POSCustomerTransactions", fields: [customerId], references: [id], onDelete: SetNull)
  customerName  String?
  customerPhone String?

  // Cashier
  cashierId String @db.ObjectId
  cashier   User   @relation("POSTransactionCashier", fields: [cashierId], references: [id])

  // Financials
  subtotal        Float @default(0)
  discountAmount  Float @default(0)
  discountPercent Float @default(0)
  taxAmount       Float @default(0)
  taxPercent      Float @default(0)
  totalAmount     Float @default(0)
  amountPaid      Float @default(0) // Alias for paidAmount
  paidAmount      Float @default(0)
  changeGiven     Float @default(0) // Alias for changeAmount
  changeAmount    Float @default(0)

  // Payment Info - Primary method and breakdown
  paymentMethod  String  @default("CASH") // CASH, CARD, UPI, WALLET, MIXED
  cashAmount     Float   @default(0)
  cardAmount     Float   @default(0)
  upiAmount      Float   @default(0)
  walletAmount   Float   @default(0)
  paymentDetails String? // JSON for mixed payments

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items POSTransactionItem[]

  @@index([organizationId, status])
  @@index([posLocationId])
  @@index([transactionDate])
}

// POS Transaction Item - Line items in a retail transaction
model POSTransactionItem {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  transactionId String         @db.ObjectId
  transaction   POSTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  productId     String         @db.ObjectId
  product       Product        @relation("POSTransactionItemProduct", fields: [productId], references: [id])

  productName    String // Snapshot of product name at time of sale
  productSku     String? // Snapshot of product SKU
  quantity       Float
  unitPrice      Float
  discountAmount Float   @default(0)
  taxRate        Float   @default(0)
  total          Float

  @@index([transactionId])
}

// POS Customer - Retail customers for POS transactions
model POSCustomer {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  posLocationId  String?      @db.ObjectId
  posLocation    POSLocation? @relation("POSLocationCustomers", fields: [posLocationId], references: [id], onDelete: SetNull)

  // Customer Info
  name    String
  phone   String?
  email   String?
  address String?

  // Loyalty & Analytics
  totalSpent    Float     @default(0)
  visitCount    Int       @default(0)
  lastVisitDate DateTime?
  loyaltyPoints Int       @default(0)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  transactions POSTransaction[] @relation("POSCustomerTransactions")

  @@index([organizationId])
  @@index([posLocationId])
  @@index([phone])
}

// POS Session - Cashier session management
model POSSession {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  posLocationId  String?      @db.ObjectId
  posLocation    POSLocation? @relation("POSLocationSessions", fields: [posLocationId], references: [id], onDelete: SetNull)

  // Session Info
  sessionNumber String @unique
  cashierId     String @db.ObjectId
  cashier       User   @relation("POSSessionCashier", fields: [cashierId], references: [id])

  // Status: OPEN, CLOSED, SUSPENDED
  status String @default("OPEN")

  // Opening
  openingBalance Float    @default(0)
  openedAt       DateTime @default(now())

  // Closing
  closingBalance Float?
  closedAt       DateTime?
  actualCash     Float?
  cashDifference Float?    @default(0)
  closingNotes   String?

  // Totals
  totalSales       Float @default(0)
  totalCash        Float @default(0)
  totalCard        Float @default(0)
  totalUpi         Float @default(0)
  transactionCount Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
  @@index([cashierId])
  @@index([openedAt])
}

// ============================================
// DATA IMPORT MODELS
// ============================================

// Import Batch - Tracks each import operation for audit
model ImportBatch {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  userId String @db.ObjectId
  user   User   @relation("ImportBatchUser", fields: [userId], references: [id])

  // Import type: PRODUCT, CONNECTION, PRICING, OPENING_BALANCE
  entityType String

  // File info
  sourceFileName String
  sourceFileUrl  String? // Azure Blob URL for audit
  fileFormat     String // EXCEL, CSV, XML

  // Import stats
  totalRows    Int
  successCount Int @default(0)
  errorCount   Int @default(0)
  warningCount Int @default(0)
  skipCount    Int @default(0)
  updateCount  Int @default(0)
  createCount  Int @default(0)

  // Status: PENDING, PROCESSING, COMPLETED, FAILED, ROLLED_BACK
  status String @default("PENDING")

  // Detailed reports stored as JSON
  errorReport   Json? // Array of { row, field, message }
  warningReport Json? // Array of { row, field, message }
  mappingConfig Json? // Column mapping used for import

  // Rollback support
  rolledBackAt DateTime?
  rolledBackBy String?   @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  importRecords ImportRecord[]

  @@index([organizationId, entityType])
  @@index([organizationId, status])
  @@index([userId])
  @@index([createdAt])
}

// Import Record - Tracks individual records created/updated by import
model ImportRecord {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  importBatchId String      @db.ObjectId
  importBatch   ImportBatch @relation(fields: [importBatchId], references: [id], onDelete: Cascade)

  // What was imported
  entityType String // PRODUCT, CONNECTION, etc.
  entityId   String @db.ObjectId // ID of created/updated record
  action     String // CREATE, UPDATE, SKIP

  // Original row data for potential rollback
  sourceRowNumber Int
  sourceData      Json? // Original row data
  previousData    Json? // Previous state (for updates)

  createdAt DateTime @default(now())

  @@index([importBatchId])
  @@index([entityType, entityId])
}

// ==========================================
// HR & Payroll Management System
// ==========================================

// Holiday - Organization holidays calendar
model Holiday {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String // e.g., "Diwali", "Christmas", "Republic Day"
  date           DateTime // The holiday date
  isPaid         Boolean      @default(true) // Is this a paid holiday?
  isRecurring    Boolean      @default(false) // Repeats every year on same date
  description    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, date])
  @@index([organizationId])
  @@index([date])
}

// WeeklyOff - Recurring weekly off days configuration
model WeeklyOff {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  dayOfWeek      Int // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  isPaid         Boolean      @default(true) // Is this a paid off day?
  isHalfDay      Boolean      @default(false) // Is this a half-day (e.g., Saturday half-day)?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, dayOfWeek])
  @@index([organizationId])
}

// SalaryComponent - Configurable salary components (allowances/deductions)
model SalaryComponent {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String       @db.ObjectId
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name            String // e.g., "Basic Pay", "HRA", "TA", "PF", "TDS"
  type            String // "EARNING" or "DEDUCTION"
  calculationType String // "FIXED" or "PERCENTAGE"
  defaultValue    Float        @default(0) // Default amount or percentage
  isActive        Boolean      @default(true)
  isTaxable       Boolean      @default(true) // Is this component taxable?
  description     String?
  sortOrder       Int          @default(0) // Display order
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  employeeSalaryComponents EmployeeSalaryComponent[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

// EmployeeSalary - Salary structure for each employee
model EmployeeSalary {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Salary configuration
  salaryType     String       @default("MONTHLY") // "MONTHLY" or "DAILY"
  basicPay       Float // Base salary amount
  effectiveFrom  DateTime     @default(now()) // When this salary structure is effective
  effectiveTo    DateTime? // End date (null = current)
  
  // Employment details
  employeeId     String? // Employee ID/Code (e.g., "EMP001")
  designation    String? // Job title/designation
  joiningDate    DateTime?
  bankAccountNo  String?
  bankIfscCode   String?
  bankName       String?
  panNumber      String?
  
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  components   EmployeeSalaryComponent[]
  payrollItems PayrollItem[]

  @@index([organizationId])
  @@index([userId])
  @@index([effectiveFrom])
}

// EmployeeSalaryComponent - Individual salary components for an employee
model EmployeeSalaryComponent {
  id                 String          @id @default(auto()) @map("_id") @db.ObjectId
  employeeSalaryId   String          @db.ObjectId
  employeeSalary     EmployeeSalary  @relation(fields: [employeeSalaryId], references: [id], onDelete: Cascade)
  salaryComponentId  String          @db.ObjectId
  salaryComponent    SalaryComponent @relation(fields: [salaryComponentId], references: [id], onDelete: Cascade)
  
  // Override values for this employee
  calculationType    String // "FIXED" or "PERCENTAGE" (can override component default)
  value              Float // Amount or percentage value
  
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@unique([employeeSalaryId, salaryComponentId])
  @@index([employeeSalaryId])
}

// Payroll - Monthly payroll batch
model Payroll {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  month          Int // 1-12
  year           Int // e.g., 2026
  
  // Payroll totals
  totalGrossPay  Float        @default(0)
  totalDeductions Float       @default(0)
  totalNetPay    Float        @default(0)
  totalOvertime  Float        @default(0)
  employeeCount  Int          @default(0)
  
  status         String       @default("DRAFT") // "DRAFT", "PROCESSING", "PROCESSED", "PAID"
  processedAt    DateTime?
  paidAt         DateTime?
  processedById  String?      @db.ObjectId
  processedBy    User?        @relation("PayrollProcessor", fields: [processedById], references: [id], onDelete: SetNull)
  
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  items PayrollItem[]

  @@unique([organizationId, month, year])
  @@index([organizationId])
  @@index([month, year])
}

// PayrollItem - Individual employee salary in a payroll
model PayrollItem {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  payrollId        String         @db.ObjectId
  payroll          Payroll        @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  employeeSalaryId String         @db.ObjectId
  employeeSalary   EmployeeSalary @relation(fields: [employeeSalaryId], references: [id], onDelete: Cascade)
  userId           String         @db.ObjectId
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Attendance summary
  totalDays        Int // Total days in month
  workingDays      Int // Working days (excluding weekly offs & holidays)
  presentDays      Float // Days present (half days count as 0.5)
  absentDays       Float // Days absent
  paidLeaveDays    Float @default(0) // Paid leave days
  unpaidLeaveDays  Float @default(0) // Unpaid leave days
  holidayDays      Int   @default(0) // Holiday days
  weeklyOffDays    Int   @default(0) // Weekly off days
  
  // Overtime
  overtimeHours    Float @default(0)
  overtimeRate     Float @default(1.5) // Multiplier (1.5x, 2x)
  overtimeAmount   Float @default(0)
  
  // Bonus
  bonusAmount      Float @default(0) // Total bonus for this payroll period
  bonusBreakdown   Json? // { "Performance": 5000, "Festival": 2000, ... }
  
  // Employee Product Purchase Deductions
  purchaseDeduction Float @default(0) // Total deduction for product purchases
  purchaseBreakdown Json? // [{ productName: "...", quantity: 2, amount: 500 }, ...]
  
  // Pay calculation
  basicPay         Float // Base pay for the period
  grossEarnings    Float // Total earnings (basic + allowances + overtime + bonus)
  totalDeductions  Float // Total deductions (including purchase deductions)
  netPay           Float // Final amount payable
  
  // Breakdown stored as JSON for flexibility
  earningsBreakdown   Json? // { "HRA": 5000, "TA": 2000, "Bonus": 3000, ... }
  deductionsBreakdown Json? // { "PF": 1800, "TDS": 500, "Product Purchases": 1000, ... }
  
  // Payment tracking
  status           String    @default("PENDING") // "PENDING", "PAID"
  paidAt           DateTime?
  paymentRef       String? // Payment reference/transaction ID
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([payrollId])
  @@index([userId])
  @@index([employeeSalaryId])
}

// LeaveType - Types of leaves available
model LeaveType {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId  String       @db.ObjectId
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name            String // e.g., "Casual Leave", "Sick Leave", "Annual Leave"
  code            String // e.g., "CL", "SL", "AL"
  isPaid          Boolean      @default(true)
  maxDaysPerYear  Float // Maximum days allowed per year
  carryForward    Boolean      @default(false) // Can unused leaves be carried forward?
  maxCarryForward Float        @default(0) // Max days that can be carried forward
  description     String?
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  leaveBalances LeaveBalance[]

  @@unique([organizationId, code])
  @@index([organizationId])
}

// LeaveBalance - Track leave balance for each employee per leave type
model LeaveBalance {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaveTypeId    String       @db.ObjectId
  leaveType      LeaveType    @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)
  
  year           Int // Financial/calendar year
  allocated      Float // Total allocated for the year
  used           Float        @default(0) // Used leaves
  pending        Float        @default(0) // Pending approval
  carriedForward Float        @default(0) // Carried from previous year
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([userId, leaveTypeId, year])
  @@index([organizationId])
  @@index([userId])
  @@index([year])
}

// OvertimeRecord - Track overtime hours
model OvertimeRecord {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date           DateTime
  hours          Float // Overtime hours
  rate           Float        @default(1.5) // Rate multiplier (1.5x, 2x)
  reason         String? // Reason for overtime
  
  status         String       @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  approvedById   String?      @db.ObjectId
  approvedBy     User?        @relation("OvertimeApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedAt     DateTime?
  
  // Calculated amount (based on daily rate * hours * multiplier)
  amount         Float        @default(0)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([date])
  @@index([status])
}

// EmployeePurchase - Track employee purchases of company products (deducted from salary)
model EmployeePurchase {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId      String       @db.ObjectId
  product        Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  quantity       Float // Quantity purchased
  unitPrice      Float // Price per unit at time of purchase
  totalAmount    Float // Total amount (quantity * unitPrice)
  
  purchaseDate   DateTime     @default(now()) // When the purchase was made
  month          Int // Month for payroll deduction (1-12)
  year           Int // Year for payroll deduction
  
  // Deduction tracking
  isDeducted     Boolean      @default(false) // Has this been deducted from payroll?
  payrollItemId  String?      @db.ObjectId // Link to payroll item when deducted
  deductedAt     DateTime?
  
  notes          String?
  createdById    String       @db.ObjectId
  createdBy      User         @relation("EmployeePurchaseCreator", fields: [createdById], references: [id], onDelete: Cascade)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([productId])
  @@index([month, year])
  @@index([isDeducted])
}

// EmployeeBonus - Track bonus payments for employees
model EmployeeBonus {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String       @db.ObjectId
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String       @db.ObjectId
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  amount         Float // Bonus amount
  bonusType      String // "PERFORMANCE", "FESTIVAL", "ANNUAL", "SPECIAL", "OTHER"
  month          Int // Month for payroll inclusion (1-12)
  year           Int // Year for payroll inclusion
  
  reason         String? // Reason for bonus
  
  // Payroll tracking
  isIncluded     Boolean      @default(false) // Has this been included in payroll?
  payrollItemId  String?      @db.ObjectId // Link to payroll item when included
  includedAt     DateTime?
  
  approvedById   String?      @db.ObjectId
  approvedBy     User?        @relation("BonusApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedAt     DateTime?
  
  createdById    String       @db.ObjectId
  createdBy      User         @relation("BonusCreator", fields: [createdById], references: [id], onDelete: Cascade)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([month, year])
  @@index([isIncluded])
}


// ==========================================
// EXPENSE TRACKING SYSTEM
// ==========================================

enum ExpenseCategoryType {
  MILK_PROCUREMENT
  RAW_MATERIAL_PURCHASE
  TRANSPORTATION
  ELECTRICITY
  LABOR_WAGES
  EQUIPMENT_MAINTENANCE
  RENT
  TESTING_QC
  OVERHEAD
  PAYROLL
  OTHER
}

// ExpenseCategory - Configurable expense categories per organization
model ExpenseCategory {
  id             String              @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String              @db.ObjectId
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String              // Display name: "Milk Procurement", "Electricity", etc.
  type           ExpenseCategoryType // Enum type for system identification
  description    String?
  isDefault      Boolean             @default(false) // System-seeded default categories
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  expenses          Expense[]
  recurringExpenses RecurringExpense[]

  @@unique([organizationId, type])
  @@index([organizationId])
}

// Expense - Individual expense entries (auto-generated or manual)
model Expense {
  id             String          @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String          @db.ObjectId
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  categoryId     String          @db.ObjectId
  category       ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  amount         Float
  date           DateTime
  description    String
  notes          String?
  session        String?         // "morning" or "evening" (for dairy-related expenses)

  // Auto-generation tracking
  isAutoGenerated Boolean  @default(false)
  sourceType      String?  // "MANUAL", "MILK_PROCUREMENT", "PURCHASE_ORDER", "PAYROLL", "BILL", "RECURRING"
  sourceId        String?  // Polymorphic reference to the originating record ID

  // Relations
  supplierId          String?               @db.ObjectId
  supplier            Connection?           @relation("ExpenseSupplier", fields: [supplierId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  collectionCenterId  String?               @db.ObjectId
  collectionCenter    MilkCollectionCenter? @relation("ExpenseCollectionCenter", fields: [collectionCenterId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdById         String                @db.ObjectId
  createdBy           User                  @relation("ExpenseCreator", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Payment tracking
  paymentStatus String @default("PAID") // "PENDING", "PAID", "PARTIAL"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([categoryId])
  @@index([date])
  @@index([sourceType, sourceId])
  @@index([supplierId])
}

// RecurringExpense - Templates for auto-generating periodic expense entries
model RecurringExpense {
  id             String          @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String          @db.ObjectId
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  categoryId     String          @db.ObjectId
  category       ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  name           String          // e.g., "Office Rent", "Electricity Bill"
  amount         Float
  description    String?
  frequency      String          // "DAILY", "WEEKLY", "MONTHLY", "QUARTERLY", "YEARLY"
  startDate      DateTime
  endDate        DateTime?       // Null = runs indefinitely
  isActive       Boolean         @default(true)
  lastGeneratedDate DateTime?    // Last date an expense was auto-generated
  nextDueDate    DateTime        // Next scheduled generation date
  createdById    String          @db.ObjectId
  createdBy      User            @relation("RecurringExpenseCreator", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([organizationId])
  @@index([isActive, nextDueDate])
}